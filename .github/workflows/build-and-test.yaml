name: Build and test

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
      image:
        required: false
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    name: Build and test (Rust + TS)
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.image != '' && inputs.image || format('ghcr.io/{0}/loopautoma-ci:latest', github.repository_owner) }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Bun version
        run: bun --version || true

      - name: Install dependencies (UI)
        run: |
          if [ -f package.json ]; then bun install --frozen-lockfile || bun install; else echo "No package.json"; fi

      - name: UI tests (Vitest with coverage)
        run: |
          if [ -f package.json ]; then bun run test:ui:cov || true; else echo "No UI; skipping"; fi

      - name: Rust tests
        run: |
          if [ -d src-tauri ]; then (cd src-tauri && cargo test --all --locked); else echo "No src-tauri/; skipping"; fi

      - name: Rust coverage (tarpaulin)
        run: |
          if [ -f src-tauri/Cargo.toml ]; then (cd src-tauri && cargo tarpaulin --out Xml --timeout 120 --engine llvm || cargo tarpaulin --out Xml --timeout 120); fi

      - name: Upload coverage to Codecov (Rust)
        if: ${{ always() }}
        uses: codecov/codecov-action@v4
        with:
          files: src-tauri/tarpaulin-report.xml
          flags: rust
          fail_ci_if_error: false

      - name: Upload UI coverage to Codecov (best-effort)
        if: ${{ always() }}
        uses: codecov/codecov-action@v4
        with:
          files: coverage/lcov.info
          flags: ui
          fail_ci_if_error: false
