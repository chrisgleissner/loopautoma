name: Build and test

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
      image:
        required: false
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    name: Build and test (Rust + TS)
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.image != '' && inputs.image || format('ghcr.io/{0}/loopautoma-ci:latest', github.repository_owner) }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      CARGO_TARGET_DIR: /workspace/target
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Environment diagnostics (Rust)
        run: |
            set -x
            echo "CARGO_TARGET_DIR=${CARGO_TARGET_DIR}"
            echo "CARGO_HOME=${CARGO_HOME}"
            echo "RUSTUP_HOME=${RUSTUP_HOME}"
            echo "PWD=$(pwd)"
            which cargo || true
            cargo -vV || true
            rustc -vV || true
            echo "Listing /workspace/target (if present):"
            ls -la /workspace/target || true
            echo "Listing src-tauri/target (if present):"
            ls -la src-tauri/target || true

      - name: Bun version
        run: bun --version || true

      - name: Install system dependencies (X11 input)
        run: |
          apt-get update
          apt-get install -y --no-install-recommends libxkbcommon-x11-dev libxcb-xkb-dev
          node -v
          npm -v

      - name: Install dependencies (UI)
        run: |
          if [ -f package.json ]; then bun install --frozen-lockfile || bun install; else echo "No package.json"; fi

      - name: Install Playwright browsers
        run: |
          if [ -f package.json ]; then bunx playwright install --with-deps; else echo "No package.json"; fi

      - name: UI tests (Vitest with coverage)
        timeout-minutes: 5
        env:
          FORCE_COLOR: "1"
        run: |
          set -x
          if [ -f package.json ]; then timeout 300 bun run test:ui:cov -- --reporter=dot --reporter=verbose || true; else echo "No UI; skipping"; fi

      - name: E2E tests (Playwright with coverage)
        timeout-minutes: 10
        env:
          DEBUG: pw:webServer,pw:api
          FORCE_COLOR: "1"
        run: |
          set -x
          if [ -f package.json ]; then timeout 600 bun run test:e2e:cov || true; else echo "No UI; skipping"; fi

      - name: Free disk space before Rust coverage
        if: ${{ always() }}
        run: |
          set -x
          df -h
          rm -rf /root/.cache/ms-playwright || true
          rm -rf /root/.npm/_logs || true
          rm -rf /root/.bun/install/cache || true
          rm -rf /workspace/node_modules || true
          rm -rf /workspace/coverage || true
          rm -rf /workspace/coverage-e2e || true
          rm -rf /workspace/target || true
          rm -rf /workspace/dist || true
          rm -rf /workspace/playwright-report || true
          rm -rf /workspace/test-results || true
          rm -rf /workspace/tmp || true
          rm -rf /tmp/cargo-target || true
          rm -rf /tmp/llvm-cov* || true
          df -h

      - name: Rust coverage (llvm-cov)
        env:
          CARGO_BUILD_JOBS: 2
          RUSTFLAGS: "-Ccodegen-units=1"
          CARGO_TARGET_DIR: /tmp/cargo-target
        run: |
          if [ -f src-tauri/Cargo.toml ]; then (
            cd src-tauri && \
            rm -rf "$CARGO_TARGET_DIR" && \
            cargo llvm-cov clean --workspace && \
            cargo llvm-cov --workspace --locked --lcov --output-path lcov.info
          ); fi

      - name: Cleanup coverage target dir
        if: ${{ always() }}
        run: |
          rm -rf /tmp/cargo-target || true

      - name: Collect coverage artifacts
        id: coverage
        if: ${{ always() }}
        run: |
          set -euo pipefail
          mkdir -p coverage-artifacts
          if [ -f src-tauri/lcov.info ]; then
            cp src-tauri/lcov.info coverage-artifacts/rust.lcov
          fi
          if [ -f coverage/lcov.info ]; then
            cp coverage/lcov.info coverage-artifacts/ui.lcov
          fi
          if [ -f coverage-e2e/lcov.info ]; then
            cp coverage-e2e/lcov.info coverage-artifacts/e2e.lcov
          fi
          shopt -s nullglob
          declare -a files=()
          for f in coverage-artifacts/*.lcov; do
            files+=("$f")
          done
          if [ "${#files[@]}" -gt 0 ]; then
            (IFS=','; echo "files=${files[*]}" >> "$GITHUB_OUTPUT")
          else
            echo "files=" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload coverage to Codecov
        if: ${{ always() && steps.coverage.outputs.files != '' }}
        uses: codecov/codecov-action@v4
        with:
          files: ${{ steps.coverage.outputs.files }}
          fail_ci_if_error: false
